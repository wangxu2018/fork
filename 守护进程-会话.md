# **守护进程-会话**

## **进程组和会话**

**进程组**

- 一个或多个进程的集合，每个进程都属于一个进程组
- 父进程创建子进程的时候，默认组成一个进程组，该进程组的组id等于父进程的id

**会话(session)**

- 多个进程组的集合
- 更加方便管理进程

## **创建会话注意事项**

**注意事项**

- 调用进程不能是进程组组长，该创建会话的进程将变成新会话首进程（session header）
  - 该调用进程如果是组长进程会出错返回
  - 建立新会话时，先调用fork，父进程终止，子进程调用setsid

- 创建会话的进程将成为一个新进程组的的组长进程
- 需有root权限
- 新会话脱离原有的控制终端，新会话没有控制终端

**相关函数**

```
getsid：传入进程，传出其所在的会话
setsid：创建会话
	创建会话，并且以自己的进程id作为进程组id、新会话id
```

## **守护进程简述**

- daemon进程
- 通常运行在操作系统后台，脱离控制终端
- 一般不与用户直接交互。周期性的等待某个事件发生或周期性执行某一动作
- 不受用户登录注销影响。通常采用以d结尾的命名方式
- 创建守护进程最关键的一步就是创建一个新的session，并且成为session leader

## **守护进程创建步骤**

	1. fork子进程，让父进程终止
		- 所有工作在子进程中进行形式上脱离控制终端
	
	2. 子进程调用 setsid() 创建新会话
		- 使子进程完全独立出来，脱离控制
	
	3. 通常根据需要，改变工作目录位置 chdir()， 防止可卸载的文件系统
		- 即理解为设置daemon之后工作的新目录
	
	4. 通常根据需要，重设umask文件权限掩码，影响到新文件的创建权限。  022 -- 755	0345 --- 432   r---wx-w-   422
	
	5. 通常根据需要，关闭/重定向 文件描述符
		- 如0，1，2等用不到的默认打开的文件描述符，
		- 也可选择对这三个文件描述符进行重定向，重定向为/dev/null
	
	6. 守护进程 业务逻辑。while（）



## **相关代码实现**

- **创建会话**
  - ./code/daemon/daemon_create_session.c
- **创建守护进程**
  - ./code/daemon/daemon_create_session_daemon.c

