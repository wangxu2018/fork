# **进程相关概述**



[TOC]

## **进程和程序**

- 程序：死的。只占用磁盘空间。	――剧本
- 进程：活的。运行起来的程序。占用内存、cpu等系统资源。  ――戏

## **MMU**

- 虚拟内存映射单元，CPU内部重要的组件之一。

- **MMU作用**

  ```
  - 完成进程虚拟内存地址与物理内存之间的映射，使得一定大小的内存空间可以运行多个进程。
  - 完成用户空间和内核空间之间的权级切换。
  ```

## **虚拟内存地址**

- 每个进程会被分配4G的虚拟内存空间，其中0-3G为用户态，3-4G为内核态。

## **进程控制块**

- 在虚拟内存地址3-4G的空间中，会包含PCB（进程控制块），PCB是一个描述进程信息的结构体。

- **PCB中包含的资源**

  ```
  - 进程id
  - 文件描述符表：该进程用到的文件描述符的集合，最大为1024个，可通过修改内核代码修改上线
  - 进程状态：初始态、就绪态、运行态、挂起态、终止态
  - 进程工作目录位置
  - umask掩码
  - 信号相关信息资源
  - 用户id和组id
  ```

## **父子进程**

- **父子进程相同**

  ```
  - 创建子进程的时候，会把父进程0-3G的虚拟内存地址以及PCB（其中pid不同）复制一份给子进程。
  - 父子进程创建完成后均从创建的位置开始分别执行后面的代码。
  - 因此刚fork完，父子进程相同的有：data段、text段、堆、栈、环境变量、全局变量、宿主目录位置、进程工作目录位置、信号处理方式。
  ```

- **父子进程不同**

  ```
  进程id、返回值、各自的父进程、进程创建时间、闹钟、未决信号集
  ```

- **父子进程共享**

  ```
  - 对于全局变量来说，读时共享、写时复制的原则，节省内存开销（如果父子进程不修改，则共享同一块全局变量）
  - 共享已经打开的文件描述符
  - 共享mmap映射区（待了解）
  ```

  ## **僵尸进程孤儿进程**

  - **孤儿进程**

  父进程先于子进终止，子进程沦为孤儿进程，会被init进程领养。

  - **僵尸进程**

  	- 子进程终止，父进程尚未对子进程进行回收，在此期间，子进程为僵尸进程。
	- kill 对其无效。



## **进程间通信方式**

- 管道：pipe、fifo
- 文件
- mmap
- socket
- 信号

## **C 相关函数**

- **pid_t fork(void)**

```
- 创建子进程，父子进程各自返回
- 创建成功后，父进程返回子进程pid，子进程返回0
```

- **getpid()，getppid()**

```
- 获取父进程的id、父父继承的id
```

- **wait：阻塞回收子进程退出资源，回收任意一个**

```
pid_t wait(int *status)
参数：（传出）回收进程的状态。
返回值：成功返回回收进程的pid；失败返回-1，errno

- 作用1：阻塞等待子进程退出（只回收一个子进程）
- 作用2：清理子进程残留在内核的 pcb 资源
- 作用3：通过传出参数，得到子进程结束状态

	
获取子进程正常终止的状态：
	WIFEXITED(status) --> 为真 --> 调用 WEXITSTATUS(status) --> 得到 子进程 退出值。

获取导致子进程异常终止信号：
	WIFSIGNALED(status) --> 为真 --> 调用 WTERMSIG(status) --> 得到 导致子进程异常终止的信号编号。
```

- **waitpid：指定回收某一进程资源，可以设置非阻塞**

```
pid_t waitpid(pid_t pid, int *status, int options)
参数：
	pid：指定回收子进程pid的资源
		>0: 待回收的子进程pid
		-1：任意子进程
		0：同组的子进程。
	status：（传出） 回收进程的状态。
	options：WNOHANG指定回收方式为非阻塞。

返回值：
    >0: 表成功回收的子进程pid
     0: 函数调用时，参3 指定了WNOHANG，没有子进程结束。
    -1: 失败，errno
```

